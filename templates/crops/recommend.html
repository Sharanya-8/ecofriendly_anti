{% extends "base.html" %}
{% block title %}Crop Recommendation â€” EcoFarm AI{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-9">

            <!-- Header -->
            <div class="mb-4">
                <h2 class="fw-bold page-title"><i class="bi bi-cpu text-eco me-2"></i>AI Crop Recommendation</h2>
                <p class="text-muted">Enter your soil details â€” our ML model will recommend the best crop for your
                    conditions.</p>
                <div class="d-flex gap-3">
                    <span class="badge eco-badge-info">ðŸ§  Soil Model: {{ accuracies['soil'] }}% accuracy</span>
                    <span class="badge eco-badge-info">ðŸŒ¾ Crop Model: {{ accuracies['crop'] }}% accuracy</span>
                </div>
            </div>

            <form method="POST" action="{{ url_for('crops.recommend') }}" id="recommendForm">
                <div class="row g-4">

                    <!-- Soil Nutrients -->
                    <div class="col-12">
                        <div class="card eco-card">
                            <div class="card-header">
                                <h5 class="mb-0 fw-semibold"><i class="bi bi-graph-up me-2 text-eco"></i>Soil Nutrients
                                    (kg/ha)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Nitrogen (N)</label>
                                        <div class="input-group">
                                            <span class="input-group-text eco-input-icon">N</span>
                                            <input type="number" class="form-control eco-input" name="N" id="N"
                                                step="0.1" min="0" max="300" placeholder="0â€“300" required />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Phosphorus (P)</label>
                                        <div class="input-group">
                                            <span class="input-group-text eco-input-icon">P</span>
                                            <input type="number" class="form-control eco-input" name="P" id="P"
                                                step="0.1" min="0" max="150" placeholder="0â€“150" required />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Potassium (K)</label>
                                        <div class="input-group">
                                            <span class="input-group-text eco-input-icon">K</span>
                                            <input type="number" class="form-control eco-input" name="K" id="K"
                                                step="0.1" min="0" max="300" placeholder="0â€“300" required />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Soil Properties -->
                    <div class="col-12">
                        <div class="card eco-card">
                            <div class="card-header">
                                <h5 class="mb-0 fw-semibold"><i class="bi bi-layers me-2 text-eco"></i>Soil Properties
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">pH Value</label>
                                        <input type="number" class="form-control eco-input" name="ph" id="ph" step="0.1"
                                            min="0" max="14" placeholder="0â€“14" required />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Moisture (%)</label>
                                        <input type="number" class="form-control eco-input" name="moisture"
                                            id="moisture" step="0.1" min="0" max="100" placeholder="0â€“100" required />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Sand (%)</label>
                                        <input type="number" class="form-control eco-input" name="sand" id="sand"
                                            step="0.1" min="0" max="100" placeholder="0â€“100" required />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Clay (%)</label>
                                        <input type="number" class="form-control eco-input" name="clay" id="clay"
                                            step="0.1" min="0" max="100" placeholder="0â€“100" required />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location & Season -->
                    <div class="col-12">
                        <div class="card eco-card">
                            <div class="card-header">
                                <h5 class="mb-0 fw-semibold"><i class="bi bi-geo-alt me-2 text-eco"></i>Location & Field
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">District / City</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control eco-input" name="city" id="city"
                                                placeholder="e.g. Warangal" list="districtSuggest"
                                                value="{{ g.farmer['location'] }}" required />
                                            <button type="button" class="btn btn-outline-primary" id="liveLocationBtn" title="Use my current location">
                                                <i class="bi bi-geo-alt-fill"></i>
                                            </button>
                                        </div>
                                        <datalist id="districtSuggest">
                                            {% for d in districts %}
                                            <option value="{{ d }}">{{ d }}</option>
                                            {% endfor %}
                                        </datalist>
                                        <small class="text-muted">Or click <i class="bi bi-geo-alt-fill"></i> to use live location</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Current Month</label>
                                        <select class="form-select eco-input" name="month" id="month" required>
                                            {% set month_names =
                                            ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"] %}
                                            {% for i in range(1, 13) %}
                                            <option value="{{ i }}">{{ i }} â€“ {{ month_names[i-1] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-semibold">Field Name</label>
                                        <input type="text" class="form-control eco-input" name="field_name"
                                            id="field_name" placeholder="e.g. North Field" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 d-grid">
                        <button type="submit" class="btn btn-eco btn-lg fw-semibold" id="recommendBtn">
                            <i class="bi bi-magic me-2"></i>Get AI Recommendation
                        </button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Live Location Script -->
<script src="{{ url_for('static', filename='js/live_location.js') }}"></script>
<script>
    // Auto-select current month
    document.addEventListener('DOMContentLoaded', () => {
        const m = new Date().getMonth() + 1;
        document.getElementById('month').value = m;
        
        // Initialize live location button
        const liveLocation = new LiveLocation();
        const liveLocationBtn = document.getElementById('liveLocationBtn');
        
        if (!liveLocation.isLocationSupported()) {
            liveLocationBtn.disabled = true;
            liveLocationBtn.title = 'Geolocation not supported';
        }
        
        liveLocationBtn.addEventListener('click', async function() {
            const originalHTML = this.innerHTML;
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            try {
                const position = await liveLocation.getCurrentPosition();
                const response = await fetch('/irrigation/weather/live', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: position.latitude,
                        longitude: position.longitude
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('city').value = data.weather.city;
                    alert('âœ“ Location detected: ' + data.weather.city);
                } else {
                    alert('âœ— ' + data.message);
                }
            } catch (error) {
                alert('âœ— ' + error.message);
            } finally {
                this.disabled = false;
                this.innerHTML = originalHTML;
            }
        });
    });
</script>
{% endblock %}